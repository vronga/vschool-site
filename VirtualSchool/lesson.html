<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>VSchool – Просмотр урока</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0; background: #f5f7fa; color: #222;
      min-height: 100vh; display: flex; flex-direction: column;
    }
    header {
      background-color: #2078f4;
      color: white;
      padding: 1rem 2rem;
      font-size: 1.8rem;
      font-weight: bold;
    }
    nav {
      background-color: #145bb5;
      padding: 0.5rem 2rem;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-right: 1.5rem;
      font-weight: 600;
    }
    nav a:hover {
      text-decoration: underline;
    }
    main {
      flex: 1;
      max-width: 900px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      color: #2078f4;
      margin-top: 1.5rem;
    }
    p, li {
      line-height: 1.6;
      margin-bottom: 1rem;
      font-size: 1rem;
    }
    ul {
      padding-left: 1.2rem;
    }
    pre {
      background: #f0f0f0;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-family: Consolas, monospace;
      font-size: 0.95rem;
    }
    img.lesson-image {
      max-width: 100%;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      box-shadow: 0 3px 8px rgba(32, 120, 244, 0.3);
      user-select: none;
      pointer-events: none;
    }
    iframe, video {
      width: 100%;
      max-height: 360px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(32, 120, 244, 0.3);
      margin-top: 1rem;
      margin-bottom: 1.5rem;
    }
    /* Тест */
    .quiz {
      margin-top: 2rem;
    }
    .quiz-question {
      margin-bottom: 1.2rem;
    }
    .quiz-question h4 {
      margin-bottom: 0.5rem;
    }
    .quiz-question label {
      display: block;
      margin-left: 1rem;
      margin-bottom: 0.3rem;
      cursor: pointer;
      user-select: none;
    }
    #result {
      margin-top: 1.5rem;
      font-weight: bold;
      font-size: 1.1rem;
      color: #2078f4;
    }
    button {
      background-color: #2078f4;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 1rem;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    button:hover {
      background-color: #145bb5;
    }
    /* Сообщение об ошибке */
    .not-found {
      font-size: 1.3rem;
      font-weight: 600;
      color: #b00;
      text-align: center;
      margin-top: 3rem;
      user-select: none;
    }
    footer {
      background: #2078f4;
      color: white;
      text-align: center;
      padding: 1rem 0;
      font-size: 0.9rem;
      margin-top: auto;
    }
  </style>
</head>
<body>

<header id="headerTitle">
  VSchool – Просмотр урока
</header>

<nav>
  <a href="lessons.html">Назад к урокам</a>
  <a href="index.html">Главная</a>
</nav>

<main id="lessonContent">
  <!-- Контент урока загрузится сюда -->
</main>

<footer>
  &copy; 2025 VSchool. Все права защищены.
</footer>

<script>
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  const lessons = JSON.parse(localStorage.getItem('vsLessons') || '[]');
  const lesson = lessons[id];

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getVideoEmbedHTML(url) {
    if (!url) return '';
    const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/watch\?v=|youtube\.com\/embed\/)([\w-]+)/);
    if (ytMatch) {
      const videoId = ytMatch[1];
      return `<iframe 
        src="https://www.youtube.com/embed/${videoId}" 
        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
    }
    const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
    if (vimeoMatch) {
      const videoId = vimeoMatch[1];
      return `<iframe 
        src="https://player.vimeo.com/video/${videoId}" 
        frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`;
    }
    return `<video controls src="${escapeHtml(url)}"></video>`;
  }

  if (!lesson) {
    document.getElementById('lessonContent').innerHTML = `<p class="not-found">Урок не найден.</p>`;
  } else {
    const {
      title,
      description = '',
      content = '',
      image = '',
      video = '',
      photo = '',
      test = null
    } = lesson;

    document.getElementById('headerTitle').textContent = `VSchool – ${escapeHtml(title)}`;

    let html = '';

    html += `<h1>${escapeHtml(title)}</h1>`;
    if (description) html += `<p>${escapeHtml(description)}</p>`;
    html += `<div>${content}</div>`;

    if (photo) {
      html += `<h2>Дополнительное фото</h2><img src="${escapeHtml(photo)}" alt="Дополнительное фото" class="lesson-image">`;
    }

    if (video) {
      html += `<h2>Видео к уроку</h2>${getVideoEmbedHTML(video)}`;
    }

    if (test && Array.isArray(test.questions)) {
      html += `<h2>Проверим знания!</h2><div class="quiz" id="quiz"></div>`;
    }

    document.getElementById('lessonContent').innerHTML = html;

    if (test && Array.isArray(test.questions)) {
      const quizDiv = document.getElementById('quiz');

      function renderQuiz(questions) {
        let quizHtml = '';
        questions.forEach((q, idx) => {
          quizHtml += `
            <div class="quiz-question">
              <h4>${idx + 1}. ${escapeHtml(q.question)}</h4>
              ${q.answers.map((a) =>
                `<label><input type="radio" name="q${idx}" value="${a.correct ? '1' : '0'}"> ${escapeHtml(a.text)}</label>`
              ).join('')}
            </div>`;
        });
        quizHtml += `<button id="checkQuizBtn">Проверить ответы</button><div id="result"></div>`;
        quizDiv.innerHTML = quizHtml;

        document.getElementById('checkQuizBtn').addEventListener('click', () => {
          let score = 0;
          questions.forEach((q, idx) => {
            const options = document.getElementsByName('q'+idx);
            for (const option of options) {
              if (option.checked) {
                score += Number(option.value);
                break;
              }
            }
          });
          document.getElementById('result').textContent = `Вы набрали ${score} из ${questions.length} правильных ответов.`;
        });
      }

      renderQuiz(test.questions);
    }
  }
</script>

</body>
</html>
